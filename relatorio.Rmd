---
title: "Projeto - Águas Brasil"
author: "Renata Rojas Guerra - Thiago Tavares Lopes"
date: "`r format(Sys.time(), '%d %B %Y')`"
header-includes:
   - \usepackage[brazil]{babel}
   - \usepackage{bm}
   - \usepackage{float}
   - \usepackage{multirow}
geometry: left=2.5cm, right=2.5cm, top=2cm, bottom=2cm
toc: true #sumário
output:
  bookdown::pdf_document2:
editor_options:
  chunk_output_type: console
  markdown: 
    wrap: sentence
---
```{r, include=FALSE}
library(tidyverse)
library(lubridate)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
#AJUSTE DO BANCO
banco <- readxl::read_excel("substancias-quimicas-e-radioativas-acima-do-limite-no-brasil-2018-2020 (1).xlsx")

attach(banco)

banco<-data.frame(banco)

banco<-banco |> 
  mutate(data_da_coleta = dmy(data_da_coleta),
         data_da_analise = dmy(data_da_analise))


banco<-banco|> 
  mutate(dif_analise_coleta = data_da_analise - data_da_coleta)


```

```{r, include=FALSE}
# TEMPO MEDIO DE ANALISE DE SUBSTANCIAS MAIS FREQUENTES PARA CADA ESTADO

substancia_desejada1 <- "Trihalometanos Total"  # substitua pelo nome da substância desejada

banco$dif_analise_coleta <-as.numeric(banco$dif_analise_coleta, units = "days")

df_filtrado <- banco |> filter(substancia==substancia_desejada1)


df1<- df_filtrado |> 
  select(uf, substancia, dif_analise_coleta) 

df_media<-df1 |> 
  filter(dif_analise_coleta>0)

substancia_desejada2<-"Ácidos haloacéticos total"

df2_filtrado<-banco |> filter(substancia==substancia_desejada2)

df2<-df2_filtrado |> 
  select(uf, substancia, dif_analise_coleta)


substancia_desejada3 <- "Rádio-228"

df3_filtrado3 <- banco |> 
  filter(substancia=="Rádio-228")

df3<- df3_filtrado3 |> 
  select(uf, substancia, dif_analise_coleta)

substancia_desejada4<-"Nitrato (como N)"

df4_filtado<-banco |> 
  filter(substancia=="Nitrato (como N)")

df4<-df4_filtado |> 
  select(uf, substancia, dif_analise_coleta)



substancia_desejada5<-"Cromo"

df5_filtrado<-banco |> 
  filter(substancia == "Cromo") |> 
  select(uf, substancia, dif_analise_coleta)

df5<-df5_filtrado |> 
  select(uf, substancia, dif_analise_coleta)


substancia_desejada6<-"Chumbo"

df6<-banco |> 
  filter(substancia=="Chumbo") |> #dif_analise_coleta >=1
  select(uf, substancia, dif_analise_coleta)

substancia_desejada7<-"Mercúrio"


df7<-banco |> 
  filter(substancia=="Mercúrio") |> 
  select(uf, substancia, dif_analise_coleta)

```

```{r}

#GRÁFICO Trihalometanos Total
ggplot(df_media, aes(x = uf, y = dif_analise_coleta, fill = uf)) +
  geom_boxplot(fill = "#2874A6", color = "black") +
  labs(title = paste("Dias até a análise - ", substancia_desejada1),
       x = "Estado",
       y = "Dias") +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 360, hjust = 1, color="black"),
    axis.text.y=element_text(color="black"),
    legend.position = "none",
    plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(0, 130), breaks = seq(0, 130, by = 10)) 
#+
  #scale_fill_manual()
```


```{r}

# GRAPHS FOR Ácidos haloacéticos total
ggplot(df4, aes(x = uf, y = dif_analise_coleta, fill = uf)) +
  geom_boxplot(fill = "#2874A6", color = "black") +
  labs(title = paste("Dias até a análise - ", substancia_desejada4),
       x = "Estado",
       y = "Dias") +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 360, hjust = 1, color="black"),
    axis.text.y=element_text(color="black"),
    legend.position = "none",
    plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(0, 130), breaks = seq(0, 130, by = 10)) 

#+ geom_jitter(width = 0.2)
```


```{r}
ggplot(df3, aes(x = uf, y = dif_analise_coleta, fill = uf)) +
  geom_boxplot(fill = "#2874A6", color = "black") +
  labs(title = paste("Dias até a análise - ", substancia_desejada3),
       x = "Estado",
       y = "Dias") +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 360, hjust = 1, color="black"),
    axis.text.y=element_text(color="black"),
    legend.position = "none",
    plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10)) 
```


```{r}
ggplot(df4, aes(x = uf, y = dif_analise_coleta, fill = uf)) +
  geom_boxplot(fill = "#2874A6", color = "black") +
  labs(title = paste("Dias até a análise - ", substancia_desejada4),
       x = "Estado",
       y = "Dias") +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 360, hjust = 1, color="black"),
    axis.text.y=element_text(color="black"),
    legend.position = "none",
    plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, by = 10))
```


```{r}
ggplot(df5, aes(x = uf, y = dif_analise_coleta, fill = uf)) +
  geom_boxplot(fill = "#2874A6", color = "black") +
  labs(title = paste("Dias até a análise - ", substancia_desejada5),
       x = "Estado",
       y = "Dias") +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 360, hjust = 1, color="black"),
    axis.text.y=element_text(color="black"),
    legend.position = "none",
    plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, by = 10)) 
```


```{r}
ggplot(df6, aes(x = uf, y = dif_analise_coleta, fill = uf)) +
  geom_boxplot(fill = "#2874A6", color = "black") +
  labs(title = paste("Dias até a análise - ", substancia_desejada6),
       x = "Estado",
       y = "Dias") +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 360, hjust = 1, color="black"),
    axis.text.y=element_text(color="black"),
    legend.position = "none",
    plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10)) 

```


```{r}
ggplot(df7, aes(x = uf, y = dif_analise_coleta, fill = uf)) +
  geom_boxplot(fill = "#2874A6", color = "black") +
  labs(title = paste("Dias até a análise - ", substancia_desejada7),
       x = "Estado",
       y = "Dias") +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 360, hjust = 1, color="black"),
    axis.text.y=element_text(color="black"),
    legend.position = "none",
    plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(0, 80), breaks = seq(0, 80, by = 10)) 
```


```{r}
# g5<-cowplot::plot_grid((balanco3$g_bar),(vmi3$g_bar),(Vasopressores3$g_bar),(bloq3$g_bar),(anticoagulantes3$g_bar),(Braden3$g_bar),ncol = 2)
# 
# ggsave("Imagem_geral/g5.pdf",plot = g5, width = 16, height = 14, units = "cm")

#knitr::include_graphics("Imagem_geral/g5.pdf")

#ggsave("gf2.png", plot = last_plot(), width = 8, height = 6, dpi = 600)

```


```{r, include=FALSE}
banco_regiao<-banco |> 
  filter(regiao_geografica=="SUL") |> 
  select(uf, substancia) |> 
  group_by(uf, substancia) |> 
  summarise(n = n(), .groups = "drop") 

df_regiao<-banco_regiao |> 
  filter(n>1) |> 
  group_by(uf) |> 
  arrange(uf,desc(n))

top_subs<-df_regiao |> 
  group_by(uf) |> 
  slice_max(order_by = n, n=4) |> 
  ungroup()

View(df_regiao)
```

```{r}

# FAZER SEPARADO SE NECESSÁRIO E DEPOIS JUNTAR USANDO COWPLOT
ggplot(top_subs, aes(x = reorder(substancia, -n), y = n, fill = uf)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = n,vjust = -0.5))+
  facet_wrap(~ uf, scales = "free") +
  labs(title = "Top 4 Substâncias por Frequência em Cada Estado",
       x = "Substância",
       y = "Frequência") +
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = 'none') 
```

```{r}
ggplot(top_subs, aes(x = substancia, y = n, fill = uf)) +
  geom_bar(stat = "identity", position = "stack") +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5)) +
  labs(title = "Top 4 Substâncias por Frequência em Cada Estado",
       x = "Substância",
       y = "Frequência") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


```{r}
ggplot(top_subs, aes(x = substancia, y = n, fill = uf)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = n), position = position_dodge(width = 0.9), vjust = -0.5) +
  labs(title = "Top 4 Substâncias por Frequência em Cada Estado",
       x = "Substância",
       y = "Frequência") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```



---
title: "Projeto - Águas Brasil"
author: "Renata Rojas Guerra - Thiago Tavares Lopes"
date: "`r format(Sys.time(), '%d %B %Y')`"
header-includes:
   - \usepackage[brazil]{babel}
   - \usepackage{bm}
   - \usepackage{float}
   - \usepackage{multirow}
geometry: left=2.5cm, right=2.5cm, top=2cm, bottom=2cm
toc: true #sumário
output:
  bookdown::pdf_document2:
editor_options:
  chunk_output_type: console
  markdown: 
    wrap: sentence
---
```{r, include=FALSE}
library(tidyverse)
library(lubridate)
library(kableExtra)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.pos = 'H',
                      fig.align = 'center') #, fig.width = 6.5, fig.height = 3.4
```

```{r, include=FALSE}
#AJUSTE DO BANCO
banco <- readxl::read_excel("substancias-quimicas-e-radioativas-acima-do-limite-no-brasil-2018-2020 (1).xlsx")

attach(banco)

banco<-data.frame(banco)

banco<-banco |> 
  mutate(data_da_coleta = dmy(data_da_coleta),
         data_da_analise = dmy(data_da_analise))


banco<-banco|> 
  mutate(dif_analise_coleta = data_da_analise - data_da_coleta)


```

```{r, include=FALSE}
# TEMPO MEDIO DE ANALISE DE SUBSTANCIAS MAIS FREQUENTES PARA CADA ESTADO

substancia_desejada1 <- "Trihalometanos Total"  # substitua pelo nome da substância desejada

banco$dif_analise_coleta <-as.numeric(banco$dif_analise_coleta, units = "days")

df_filtrado <- banco |> filter(substancia==substancia_desejada1)


df1<- df_filtrado |> 
  select(uf, substancia, dif_analise_coleta) 

df_media<-df1 |> 
  filter(dif_analise_coleta>0)

substancia_desejada2<-"Ácidos haloacéticos total"

df2_filtrado<-banco |> filter(substancia==substancia_desejada2)

df2<-df2_filtrado |> 
  select(uf, substancia, dif_analise_coleta)


substancia_desejada3 <- "Rádio-228"

df3_filtrado3 <- banco |> 
  filter(substancia=="Rádio-228")

df3<- df3_filtrado3 |> 
  select(uf, substancia, dif_analise_coleta)

substancia_desejada4<-"Nitrato (como N)"

df4_filtado<-banco |> 
  filter(substancia=="Nitrato (como N)")

df4<-df4_filtado |> 
  select(uf, substancia, dif_analise_coleta)



substancia_desejada5<-"Cromo"

df5_filtrado<-banco |> 
  filter(substancia == "Cromo") |> 
  select(uf, substancia, dif_analise_coleta)

df5<-df5_filtrado |> 
  select(uf, substancia, dif_analise_coleta)


substancia_desejada6<-"Chumbo"

df6<-banco |> 
  filter(substancia=="Chumbo") |> #dif_analise_coleta >=1
  select(uf, substancia, dif_analise_coleta)

substancia_desejada7<-"Mercúrio"


df7<-banco |> 
  filter(substancia=="Mercúrio") |> 
  select(uf, substancia, dif_analise_coleta)

```

# Introdução

# Análise Geral

```{r, echo=FALSE}
banco_top10_sub<-banco |> 
  group_by(substancia) |> 
  summarise(municipio=n()) |> 
  arrange(desc(municipio)) |> drop_na() |> 
  slice_head(n=10)
  
knitr::kable(banco_top10_sub, format = "latex", booktabs = TRUE, caption = "Top 10 Substâncias") |> 
  kable_styling(latex_options = c("striped","HOLD_position"))
  

```

XX

```{r, fig.align='center', fig.width=11, fig.height=4}
ggplot(banco_top10_sub, aes(x=reorder(substancia, municipio), y=municipio)) +
  geom_bar(stat="identity", fill="#009afe", color="black") + 
  labs(x = "Substância",
       y = "")+
  theme_bw()+
  geom_text(aes(label = municipio, vjust=-0.3, hjust = -0.1))+
  coord_flip() 
  
```

XXX


```{r, fig.align='center', fig.width=10, fig.height=6}

#GRÁFICO Trihalometanos Total
ggplot(df_media, aes(x = uf, y = dif_analise_coleta, fill = uf)) +
  geom_boxplot(fill = "#009afe", color = "black") +
  labs(title = "",
       x = "Estado",
       y = "Dias") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 360, hjust = 0.5, color="black"),
    axis.text.y=element_text(color="black", size = 11),
    axis.ticks.length = unit(0.3, "cm"),
    legend.position = "none",
    plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(0, 130), breaks = seq(0, 130, by = 10)) 
```


```{r, fig.align='center', fig.width=10, fig.height=6}

# GRAPHS FOR Ácidos haloacéticos total
ggplot(df4, aes(x = uf, y = dif_analise_coleta, fill = uf)) +
  geom_boxplot(fill = "#009afe", color = "black") +
  labs(title = paste("Dias até a análise - ", substancia_desejada4),
       x = "Estado",
       y = "Dias") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 360, hjust = 0.5, color="black"),
    axis.text.y=element_text(color="black"),
    legend.position = "none",
    plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, by = 10)) 

#+ geom_jitter(width = 0.2)
```


```{r, fig.align='center', fig.width=10, fig.height=6}
ggplot(df3, aes(x = uf, y = dif_analise_coleta, fill = uf)) +
  geom_boxplot(fill = "#009afe", color = "black") +
  labs(title = paste("Dias até a análise - ", substancia_desejada3),
       x = "Estado",
       y = "Dias") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 360, hjust = 0.5, color="black"),
    axis.text.y=element_text(color="black"),
    legend.position = "none",
    plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10)) 
```


```{r, fig.align='center', fig.width=10, fig.height=6}
ggplot(df4, aes(x = uf, y = dif_analise_coleta, fill = uf)) +
  geom_boxplot(fill = "#009afe", color = "black") +
  labs(title = paste("Dias até a análise - ", substancia_desejada4),
       x = "Estado",
       y = "Dias") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 360, hjust = 0.5, color="black"),
    axis.text.y=element_text(color="black"),
    legend.position = "none",
    plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, by = 10))
```


```{r, fig.align='center', fig.width=10, fig.height=6}
ggplot(df5, aes(x = uf, y = dif_analise_coleta, fill = uf)) +
  geom_boxplot(fill = "#009afe", color = "black") +
  labs(title = paste("Dias até a análise - ", substancia_desejada5),
       x = "Estado",
       y = "Dias") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 360, hjust = 0.5, color="black"),
    axis.text.y=element_text(color="black"),
    legend.position = "none",
    plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, by = 10)) 
```


```{r, fig.align='center', fig.width=10, fig.height=6}
ggplot(df6, aes(x = uf, y = dif_analise_coleta, fill = uf)) +
  geom_boxplot(fill = "#009afe", color = "black") +
  labs(title = paste("Dias até a análise - ", substancia_desejada6),
       x = "Estado",
       y = "Dias") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 360, hjust = 0.5, color="black"),
    axis.text.y=element_text(color="black"),
    legend.position = "none",
    plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10)) 

```


```{r, fig.align='center', fig.width=10, fig.height=6}
ggplot(df7, aes(x = uf, y = dif_analise_coleta, fill = uf)) +
  geom_boxplot(fill = "#009afe", color = "black") +
  labs(title = paste("Dias até a análise - ", substancia_desejada7),
       x = "Estado",
       y = "Dias") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 360, hjust = 0.5, color="black"),
    axis.text.y=element_text(color="black"),
    legend.position = "none",
    plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(0, 80), breaks = seq(0, 80, by = 10)) 
```


```{r}
# g5<-cowplot::plot_grid((balanco3$g_bar),(vmi3$g_bar),(Vasopressores3$g_bar),(bloq3$g_bar),(anticoagulantes3$g_bar),(Braden3$g_bar),ncol = 2)
# 
# ggsave("Imagem_geral/g5.pdf",plot = g5, width = 16, height = 14, units = "cm")

#knitr::include_graphics("Imagem_geral/g5.pdf")

#ggsave("gf2.png", plot = last_plot(), width = 8, height = 6, dpi = 600)

```

# Substâncias por Região

```{r, include=FALSE}
# REGIÃO SUL
banco_regiao_sul<-banco |> 
  filter(regiao_geografica=="SUL") |> 
  select(uf, substancia) |> 
  group_by(uf, substancia) |> 
  summarise(n = n(), .groups = "drop") 

df_regiao_sul<-banco_regiao_sul |> 
  filter(n>1) |> 
  group_by(uf) |> 
  arrange(uf,desc(n))

top_subs_sul<-df_regiao_sul |> 
  group_by(uf) |> 
  slice_max(order_by = n, n=4) |> 
  ungroup()

# REGIAO SUDESTE
banco_regiao_sudeste <- banco |> 
  filter(regiao_geografica=="SUDESTE") |> 
  select(uf, substancia) |> 
  group_by(uf, substancia) |> 
  summarise(n=n(), .groups = "drop") |> drop_na()

df_regiao_sudeste<-banco_regiao_sudeste |> 
  filter(n>1) |> 
  group_by(uf) |> 
  arrange(uf, desc(n))

top_subs_sudeste<-df_regiao_sudeste |> 
  group_by(uf) |> 
  slice_max(order_by = n, n=4) |> 
  ungroup()

# REGIAO NORDESTE - FAZER APENAS A TABELA

# banco_regiao_nordeste <- banco |> 
#   filter(regiao_geografica=="NORDESTE") |> 
#   select(uf, substancia) |> 
#   group_by(uf, substancia) |> 
#   summarise(n=n(), .groups = "drop") |> drop_na()
# 
# df_regiao_nordeste<-banco_regiao_nordeste |> 
#   filter(n>1) |> 
#   group_by(uf) |> 
#   arrange(uf, desc(n))

# top_subs_sudeste<-df_regiao_sudeste |> 
#   group_by(uf) |> 
#   slice_max(order_by = n, n=4) |> 
#   ungroup()


# REGIAO CENTRO-OESTE

banco_regiao_centro <- banco |> 
  filter(regiao_geografica=="CENTRO-OESTE") |> 
  select(uf, substancia) |> 
  group_by(uf, substancia) |> 
  summarise(n=n(), .groups = "drop") |> drop_na()

df_regiao_centro<-banco_regiao_centro |>
  #filter(n>1) |>
  group_by(uf) |>
  arrange(uf, desc(n))

# top_subs_sudeste<-df_regiao_sudeste |> 
#   group_by(uf) |> 
#   slice_max(order_by = n, n=4) |> 
#   ungroup()





```




```{r,fig.align='center', fig.width=10, fig.height=6}

# FAZER SEPARADO SE NECESSÁRIO E DEPOIS JUNTAR USANDO COWPLOT

# REGIAO SUL
ggplot(top_subs_sul, aes(x = reorder(substancia, -n), y = n, fill = uf)) +
  geom_bar(stat = "identity", , fill="#009afe") +
  geom_text(aes(label = n,vjust = -0.5))+
  facet_wrap(~ uf, scales = "free") +
  labs(title = "Top 4 Substâncias por Frequência em Cada Estado",
       x = "Substância",
       y = "Frequência") +
  theme_bw()+
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.line = element_line(color="black", size = 0.5),
        axis.ticks = element_line(color="black", size = 0.5),
        axis.title = element_text(color="black", size =10))



ggplot(top_subs_sul, aes(x = reorder(substancia, -n), y = n, fill = uf)) +
  geom_bar(stat = "identity", , fill="#009afe") +
  geom_text(aes(label = n,vjust = -0.5))+
  facet_wrap(~ uf, scales = "free") +
  labs(title = "Top 4 Substâncias por Frequência em Cada Estado",
       x = "Substância",
       y = "Frequência") +
  theme_bw()+
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.line = element_line(color="black", size = 0.5),
        axis.ticks = element_line(color="black", size = 0.5),
        axis.title = element_text(color="black", size =10))

# APENAS RS 
top_sub_rs <- df_regiao_sul |> 
  filter(uf=="RS")

ggplot(top_sub_rs, aes(x = reorder(substancia, n), y = n, fill = uf)) +
  geom_bar(stat = 'identity', fill = "#009afe") + 
  geom_text(aes(label= n, vjust = -0.1, hjust = -0.3))+
  theme_bw() + 
  coord_flip() +
  labs(x = "Substância",
       y = " ", 
       title = " " )+
  theme( legend.position = "none", # Posição da legenda dentro do gráfico
    axis.line = element_line(color = "black"), # Linha do eixo
    axis.ticks = element_line(color = "black"), # Adicionar todos os ticks
    axis.ticks.length = unit(0.3, "cm"), # Ajustar comprimento dos ticks
    axis.ticks.x.top = element_blank(), # Remover ticks no topo
    axis.ticks.y.right = element_blank(), # Remover ticks à direita
    axis.text.x = element_text(size = 12, color = "black"), # Texto dos ticks do eixo X em preto e tamanho 12
    axis.text.y = element_text(size = 12, color = "black"),
    axis.text.x.top = element_blank(), # Remover texto dos ticks no topo
    axis.text.y.right = element_blank())

# APENAS SC
top_sub_SC <- df_regiao_sul |> 
  filter(uf=="SC") |> 
  filter(n>3)|> drop_na()

ggplot(top_sub_SC, aes(x = reorder(substancia, n), y = n, fill = uf)) +
  geom_bar(stat = 'identity', fill = "#009afe") + 
  geom_text(aes(label= n, vjust = -0.1, hjust = -0.3))+
  theme_bw() + 
  coord_flip() +
  labs(x = "Substância",
       y = " ", 
       title = "" )+
  theme(legend.position = "none", # Posição da legenda dentro do gráfico
    axis.line = element_line(color = "black"), # Linha do eixo
    axis.ticks = element_line(color = "black"), # Adicionar todos os ticks
    axis.ticks.length = unit(0.3, "cm"), # Ajustar comprimento dos ticks
    axis.ticks.x.top = element_blank(), # Remover ticks no topo
    axis.ticks.y.right = element_blank(), # Remover ticks à direita
    axis.text.x = element_text(size = 12, color = "black"), # Texto dos ticks do eixo X em preto e tamanho 12
    axis.text.y = element_text(size = 12, color = "black"),
    axis.text.x.top = element_blank(), # Remover texto dos ticks no topo
    axis.text.y.right = element_blank()) +
    scale_y_continuous(limits = c(0, 300), breaks = seq(0, 300, by = 100))

# SUBSTANCIAS PARANA

top_sub_PR <- df_regiao_sul |> 
  filter(uf=="PR") |> 
  filter(n>3)|> drop_na()

ggplot(top_sub_PR, aes(x = reorder(substancia, n), y = n, fill = uf)) +
  geom_bar(stat = 'identity', fill = "#009afe") + 
  geom_text(aes(label= n, vjust = -0.01, hjust = -0.4))+
  theme_bw() + 
  coord_flip() +
  labs(x = "Substância",
       y = " ", 
       title = "" )+
  theme(legend.position = "none", # Posição da legenda dentro do gráfico
    axis.line = element_line(color = "black"), # Linha do eixo
    axis.ticks = element_line(color = "black"), # Adicionar todos os ticks
    axis.ticks.length = unit(0.3, "cm"), # Ajustar comprimento dos ticks
    axis.ticks.x.top = element_blank(), # Remover ticks no topo
    axis.ticks.y.right = element_blank(), # Remover ticks à direita
    axis.text.x = element_text(size = 12, color = "black"), # Texto dos ticks do eixo X em preto e tamanho 12
    axis.text.y = element_text(size = 12, color = "black"),
    axis.text.x.top = element_blank(), # Remover texto dos ticks no topo
    axis.text.y.right = element_blank()) +
    scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10))

# top_row_plot<-cowplot::plot_grid(gfRS,gfSC, ncol = 2, rel_widths = c(1,1))
# combined_plot <- cowplot::plot_grid(top_row_plot, gfPR, ncol = 1, rel_heights = c(2, 1))




```


```{r, fig.align='center', fig.width=12, fig.height=15}
# GRAFICOS SUDESTE


ggplot(top_subs_sudeste, aes(x = reorder(substancia, -n), y = n, fill = uf)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = n,vjust = -0.5))+
  facet_wrap(~ uf, scales = "free") +
  labs(title = "Top 4 Substâncias por Frequência em Cada Estado",
       x = "Substância",
       y = "Frequência") +
  theme_bw()+
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.line = element_line(color="black", size = 0.5),
        axis.ticks = element_line(color="black", size = 0.5),
        axis.title = element_text(color="black", size =10))

```




```{r}
# ggplot(top_subs_sul, aes(x = substancia, y = n, fill = uf)) +
#   geom_bar(stat = "identity", position = "stack") +
#   geom_text(aes(label = n), position = position_stack(vjust = 0.5)) +
#   labs(title = "Top 4 Substâncias por Frequência em Cada Estado",
#        x = "Substância",
#        y = "Frequência") +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


```{r}
# ggplot(top_subs_sul, aes(x = substancia, y = n, fill = uf)) +
#   geom_bar(stat = "identity", position = "dodge") +
#   geom_text(aes(label = n), position = position_dodge(width = 0.9), vjust = -0.5) +
#   labs(title = "Top 4 Substâncias por Frequência em Cada Estado",
#        x = "Substância",
#        y = "Frequência") +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


